trigger:
  branches:
    include:
      - main
  paths:
    include:
      - backend-a/**
      - backend-b/**
      - k8s/**
      - pipelines/api.yml

pool:
  vmImage: ubuntu-latest

# =========================================================
# VARIABLES
# =========================================================
variables:
- group: db-secrets

- name: AZURE_SERVICE_CONNECTION
  value: "moath-sp-new"

- name: ACR_NAME
  value: "acrmoath"

- name: ACR_LOGIN_SERVER
  value: "acrmoath.azurecr.io"

# ---------- SONARQUBE ----------
- name: SONARQUBE_URL
  value: "http://20.64.246.3:9000"

- name: SONARQUBE_PROJECT_KEY
  value: "moath-api"

- name: SONARQUBE_PROJECT_NAME
  value: "moath-api"


# =========================================================
# BUILD + SECURITY STAGE
# =========================================================
stages:
- stage: Build
  displayName: "SAST + Build + Container Scan + Push"
  jobs:
  - job: BuildPush
    steps:
    - checkout: self

    # ---------- INSTALL SONAR-SCANNER CLI ----------
    - script: |
        set -e

        echo "Downloading Sonar Scanner CLI..."
        curl -L -o sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli.zip

        echo "Unzipping..."
        unzip -q sonar-scanner.zip

        echo "Detecting scanner directory..."
        SCANNER_DIR=$(find . -maxdepth 1 -type d -name "sonar-scanner*" | head -n 1)
        echo "Scanner dir is: $SCANNER_DIR"

        echo "Making executable..."
        chmod +x $SCANNER_DIR/bin/sonar-scanner

        echo "Adding to PATH..."
        export PATH="$SCANNER_DIR/bin:$PATH"

        echo "Verify installation..."
        $SCANNER_DIR/bin/sonar-scanner --version
      displayName: "Install Sonar Scanner CLI"

    # ---------- RUN SONARQUBE SCAN ----------
    - script: |
        set -e

        SCANNER_DIR=$(find . -maxdepth 1 -type d -name "sonar-scanner*" | head -n 1)
        echo "Using scanner from: $SCANNER_DIR"

        $SCANNER_DIR/bin/sonar-scanner \
          -Dsonar.projectKey=$(SONARQUBE_PROJECT_KEY) \
          -Dsonar.projectName="$(SONARQUBE_PROJECT_NAME)" \
          -Dsonar.host.url=$(SONARQUBE_URL) \
          -Dsonar.login=$(SONARQUBE_TOKEN) \
          -Dsonar.sources=backend-a,backend-b \
          -Dsonar.java.binaries=.
      displayName: "Run SonarQube Analysis (CLI Mode)"
      env:
        SONARQUBE_TOKEN: $(SONARQUBE_TOKEN)

    # ---------- LOGIN TO ACR ----------
    - task: AzureCLI@2
      displayName: "Azure Login ACR"
      inputs:
        azureSubscription: $(AZURE_SERVICE_CONNECTION)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az acr login --name $(ACR_NAME)

    # ---------- BUILD DOCKER ----------
    - script: |
        docker build -t backend-a-local ./backend-a
        docker build -t backend-b-local ./backend-b
      displayName: "Build Docker Images"

    # ---------- INSTALL TRIVY ----------
    - script: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sh -s -- -b /usr/local/bin
      displayName: "Install Trivy"

    # ---------- SCAN BACKEND A ----------
    - script: |
        trivy image \
          --severity CRITICAL \
          --exit-code 1 \
          backend-a-local
      displayName: "Trivy Scan Backend A (Fail on Critical)"

    # ---------- SCAN BACKEND B ----------
    - script: |
        trivy image \
          --severity CRITICAL \
          --exit-code 1 \
          backend-b-local
      displayName: "Trivy Scan Backend B (Fail on Critical)"

    # ---------- TAG + PUSH ----------
    - script: |
        docker tag backend-a-local $(ACR_LOGIN_SERVER)/backend-a-moath:latest
        docker tag backend-b-local $(ACR_LOGIN_SERVER)/backend-b-moath:latest

        docker push $(ACR_LOGIN_SERVER)/backend-a-moath:latest
        docker push $(ACR_LOGIN_SERVER)/backend-b-moath:latest
      displayName: "Push Images to ACR"
